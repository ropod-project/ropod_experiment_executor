#!/usr/bin/env python
import os

import rospy
from ropod_ros_msgs.msg import ExecuteExperiment

from experiment_executor.experiment_config.sm_loader import SMLoader
from experiment_executor.experiment_config.state_machine_creator import StateMachine

class ExperimentExecutorInterface(object):
    def __init__(self):
        self.experiment_config_path = rospy.get_param('~experiment_config_path', '')
        execute_experiment_topic = rospy.get_param('~execute_experiment_topic',
                                                   '/ropod/execute_experiment')

        self.execute_experiment_sub = rospy.Subscriber(execute_experiment_topic,
                                                       ExecuteExperiment,
                                                       self.execute_experiment)

    def execute_experiment(self, msg):
        sm_config_file = os.path.join(self.experiment_config_path, msg.experiment_type + '.yaml')
        experiment_data = SMLoader.load_sm(sm_config_file)
        state_machine = StateMachine(experiment_data)
        state_machine.execute()

if __name__ == '__main__':
    rospy.init_node('experiment_executor')
    executor_interface = ExperimentExecutorInterface()
    rospy.spin()
